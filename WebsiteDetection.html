<!-- Load WebGazer.js Script -->
<script src="https://webgazer.cs.brown.edu/webgazer.js"></script>

<div id="webgazerVideoFeed" style="position: absolute; z-index: 1;"></div> <!-- Video Feed for WebGazer -->
<div id="gazeDot" style="position: absolute; z-index: 9999; width: 10px; height: 10px; background-color: red; border-radius: 50%; pointer-events: none; display: none;"></div> <!-- Gaze Dot -->

<script>
document.addEventListener("DOMContentLoaded", () => {
    window.onload = function () {
        alert('Please enable webcam permissions to start eye tracking.');
        console.log("Initializing WebGazer...");

        // Ensure WebGazer script is fully loaded before proceeding
        const script = document.createElement("script");
        script.src = "https://webgazer.cs.brown.edu/webgazer.js";
        script.onload = function () {
            console.log("WebGazer script loaded, initializing...");

            // Initialize WebGazer
            webgazer.setRegression('ridge')
                .setTracker('TFFacemesh') // Using TensorFlow Facemesh tracker
                .setGazeListener((data, clock) => {
                    if (data) {
                        console.log(`Gaze data: X=${data.x}, Y=${data.y}, Time=${clock}`);
                        
                        const dot = document.getElementById('gazeDot');
                        if (dot && data.x && data.y) {
                            // Update dot position if data is valid
                            if (data.x > 0 && data.y > 0 && data.x < window.innerWidth && data.y < window.innerHeight) {
                                dot.style.left = `${data.x - dot.offsetWidth / 2}px`;
                                dot.style.top = `${data.y - dot.offsetHeight / 2}px`;
                                dot.style.display = 'block';  // Ensure the dot is visible
                            }
                        }
                    } else {
                        console.log("No gaze data yet.");
                    }
                })
                .begin();

            // Ensure WebGazer is ready
            const checkIfReady = function () {
                if (webgazer.isReady()) {
                    console.log("WebGazer is ready! Setting up...");
                    setupWebcamFeed();  // Start video stream
                    startFaceMeshTracking(); // Begin face mesh tracking once ready
                } else {
                    console.log("WebGazer is not ready yet. Retrying...");
                    setTimeout(checkIfReady, 100);
                }
            };
            checkIfReady();
        };
        document.head.appendChild(script);

        // Setup webcam feed visibility and handle the video stream
        const setupWebcamFeed = function () {
            const video = document.getElementById('webgazerVideoFeed');
            if (video) {
                console.log("Video feed element found. Configuring...");

                // Ensure video element is properly displayed
                video.style.display = 'block'; // Show the video feed
                video.style.position = 'absolute';
                video.style.top = '0px';
                video.style.left = '0px';
                video.width = 320;
                video.height = 240;
                video.style.margin = '0px';
                video.style.zIndex = 1;  // Video feed below the gaze dot
                console.log("Video feed configured successfully.");

                // Check if video already has a stream, avoid requesting it twice
                if (!video.srcObject) {
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then((stream) => {
                            video.srcObject = stream;  // Attach webcam stream to video element
                            console.log("Webcam stream successfully started.");
                            
                            // Attach the webcam stream to WebGazer
                            webgazer.setVideoElement(video);
                            console.log("Video stream set for WebGazer.");
                        })
                        .catch((error) => {
                            console.error("Error accessing webcam stream:", error);
                        });
                } else {
                    console.log("Video feed already has a stream.");
                }
            } else {
                console.error("Video feed element not found.");
            }
        };

        // Start face mesh tracking with continuous updates
        const startFaceMeshTracking = function () {
            const trackFaceMesh = function () {
                if (webgazer.isReady()) {
                    // Continuously update face mesh and gaze data
                    webgazer.update();
                    requestAnimationFrame(trackFaceMesh); // Ensure continuous tracking
                } else {
                    console.log("WebGazer is not ready for face mesh tracking.");
                }
            };

            // Start continuous tracking
            trackFaceMesh();
        };

        // Clean up on page unload
        window.onbeforeunload = function () {
            console.log("Ending WebGazer...");
            webgazer.end();
        };

        // Check if WebGazer can access the stream after loading
        setTimeout(() => {
            if (webgazer.isReady() && webgazer.getVideoElement()) {
                console.log("WebGazer is ready and has a video element.");
            } else {
                console.error("WebGazer is not ready, or no video element found.");
            }
        }, 3000); // Check 3 seconds after page load
    };
});
</script>
